name: Daily Build and Test

on:
  schedule:
    # 每天UTC时间00:00运行（北京时间08:00）
    - cron: '0 0 * * *'
  workflow_dispatch:  # 允许手动触发

jobs:
  daily-build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest

      - name: Run tests
        run: |
          python -m pytest -v --tb=short

      - name: Build Docker image
        run: |
          docker build -t podcast-ai-system:daily .

      - name: Run basic functionality test
        run: |
          docker run --rm podcast-ai-system:daily python podcast_processor.py --help

      - name: Send notification on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Daily build failed',
              body: 'The daily build and test pipeline failed. Please check the logs.',
              labels: ['bug', 'ci']
            })